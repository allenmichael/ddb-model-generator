{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Transform": "AWS::Serverless-2016-10-31",
    "Resources": {
        "ReadCWEvents": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "CodeUri": "s3://amsxbg-ddb-code-generator/ReadCWEvents.zip",
                "Description": "A function to process all CloudWatch events generated by DynamoDB table creations",
                "FunctionName": "ReadCWEvents",
                "Handler": "ReadCWEvents::ReadCWEvents.Function::FunctionHandler",
                "MemorySize": 1024,
                "Runtime": "dotnetcore2.0",
                "Timeout": 10,
                "Policies": ["AWSLambdaFullAccess", {
                    "SNSPublishMessagePolicy": {
                        "TopicName": {
                            "Ref": "NewTableCreatedSNSTopic"
                        }
                    }
                }],
                "Environment": {
                    "Variables": {
                        "TOPIC_ARN": {
                            "Ref": "NewTableCreatedSNSTopic"
                        }
                    }
                }
            }
        },
        "GenerateDDBModel": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "CodeUri": "s3://amsxbg-ddb-code-generator/GenerateDDBModel.zip",
                "Description": "A function to generate a DynamoDB model using Roslyn when a new table is created.",
                "FunctionName": "GenerateDDBModel",
                "Handler": "GenerateDDBModel::GenerateDDBModel.Function::FunctionHandler",
                "MemorySize": 1024,
                "Runtime": "dotnetcore2.0",
                "Timeout": 10,
                "Policies": [{
                    "S3CrudPolicy": {
                        "BucketName": {
                            "Ref": "DDBModelCodeBucket"
                        }
                    }
                }],
                "Events": {
                    "NewTableCreatedSNSTopic": {
                        "Type": "SNS",
                        "Properties": {
                            "Topic": {
                                "Ref": "NewTableCreatedSNSTopic"
                            }
                        }
                    }
                },
                "Environment": {
                    "Variables": {
                        "BUCKET_NAME": {
                            "Ref": "DDBModelCodeBucket"
                        }
                    }
                }
            }
        },
        "PermissionForSNSToInvokeLambda": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "GenerateDDBModel"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "sns.amazonaws.com"
            }
        },
        "PermissionForEventsToInvokeLambda": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "ReadCWEvents"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "WatchDDBForCodeGeneration",
                        "Arn"
                    ]
                }
            }
        },
        "WatchDDBForCodeGeneration": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "State": "ENABLED",
                "EventPattern": {
                    "source": [
                        "aws.dynamodb"
                    ],
                    "detail-type": [
                        "AWS API Call via CloudTrail"
                    ],
                    "detail": {
                        "eventSource": [
                            "dynamodb.amazonaws.com"
                        ],
                        "eventName": [
                            "CreateTable"
                        ]
                    }
                },
                "Targets": [{
                    "Arn": {
                        "Fn::GetAtt": [
                            "ReadCWEvents",
                            "Arn"
                        ]
                    },
                    "Id": "CWEventsProcessor"
                }]
            }
        },
        "NewTableCreatedSNSTopic": {
            "Type": "AWS::SNS::Topic"
        },
        "DDBModelCodeBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {
                    "Fn::Join": ["-", ["ddb-model-code-bucket", {
                        "Ref": "AWS::AccountId"
                    }]]
                }
            }
        }
    },
    "Outputs": {

    }
}